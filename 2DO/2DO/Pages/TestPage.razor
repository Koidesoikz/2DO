@page "/TestPage"

@using _2DO.Data
@using System.Diagnostics

@inject NavigationManager NavigationManager

<h3>TestPage</h3>

@if (goalList == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="goalContainer">
    @foreach (Goal goal in goalList)
    {
        <input type="checkbox" checked=@goal.complete id=@goal.name @onchange="eventArgs => { CheckboxClicked(goal, eventArgs.Value); }">
        <lable for=@goal.name>@goal.name</lable>
        <img id="img-trashcan" src="images/trashcan.png" @onclick="() => RemoveSpecificGoal(goal)">
        <br />
    }
    </div>
}
<br />
<button @onclick= "() => PrintGoalListNames()">Print goalList names</button> <br />
<button @onclick="() => AddStaticGoal()">Add new static goal</button> <br />
<button @onclick="() => RemoveCompletedGoals()">Remove completed goals</button> <br />
<button @onclick="() => PrintUncompletedGoals()">Print incomplete goals</button> <br />
<br />
<button @onclick="() => CreateNewGoal()">Create new goal</button> <br />
<br />
<button @onclick="() => TestDB()">TestDB</button>
<br />
<button @onclick="() => SetupMissedDB()">Setup Database with missed goal data</button>
<br />
<br />
<h4>WARNING! THIS WILL DROP THE GOALS TABLE!!!</h4> <br />
<button @onclick="() => DropGoalsTable()">Drop Goals Table</button>
<br />

@code {
    public List<Goal> goalList = new List<Goal>();
    public SQLiteDB DB = new SQLiteDB();

    protected override async Task OnInitializedAsync()
    {
        //goalList.Add(new Goal("goal1"));
        //goalList.Add(new Goal("goal2"));
        //goalList.Add(new Goal("goal3"));

        goalList = await DB.GetAll<Goal>();

        foreach (Goal goal in goalList)
        {
            Debug.WriteLine("added the goal: " + goal.name);
        }
    }

    public async Task CheckboxClicked(Goal goal, object checkboxState)
    {
        //Add functinality
        if ((bool)checkboxState == true) {
            Debug.WriteLine($"{goal.name} was marked as completed!");
            goal.complete = true;
            goal.dateCompleted = DateTime.Now.ToString("yyyy/MM/dd");
        } else {
            Debug.WriteLine($"{goal.name} was marked as uncompleted!");
            goal.complete = false;
            goal.dateCompleted = "";
        }
        await DB.Update(goal);
    }

    public async Task RemoveSpecificGoal(Goal goal) {
        bool res = await App.Current.MainPage.DisplayAlert("Delete goal", "Are you sure you want to delete " + goal.name, "Yes", "No");
        if(res) {
            await DB.Delete<Goal>(goal);
            await RefreshGoalList();
        }
    }

    public async Task CreateNewGoal() {
        string res = await App.Current.MainPage.DisplayPromptAsync("Name your goal!", "Enter the goal you want to make!");
        Goal goal = new Goal(res, DateTime.Now);
        await DB.Insert<Goal>(goal);
        await RefreshGoalList();

    }

    //Test functions
    public void PrintGoalListNames() {
        Debug.WriteLine("Goals in goalList:");
        foreach (Goal goal in goalList) {
            Debug.WriteLine(goal.name);
        }
    }

    public async Task AddStaticGoal() {
        Debug.WriteLine("Adding static goal...");
        Goal goal = new Goal("staticGoal", DateTime.Now);
        await DB.Insert<Goal>(goal);
        await RefreshGoalList();
    }

    public async Task RemoveCompletedGoals() {
        foreach (Goal goal in goalList) {
            if(goal.complete) {
                Debug.WriteLine(goal.name);
                await DB.Delete<Goal>(goal);
            }
        }
        await RefreshGoalList();
        //goalList.RemoveAll(x => x.complete == true);
    }

    public void PrintUncompletedGoals() {
        foreach (Goal goal in goalList) {
            if(!goal.complete) {
                Debug.WriteLine(goal.name);
            }
        }
    }

    public async Task TestDB() {
        SQLiteDB DB = new SQLiteDB();
        Debug.WriteLine("Accessing Database...");
        List<Goal> allGoals =  await DB.GetAll<Goal>();
        Debug.WriteLine("Goals acquired");


        foreach(Goal g in allGoals) {
            Debug.WriteLine("Goal Name: " + g.name);
            Debug.WriteLine("Goal Id: " + g.id);
            Debug.WriteLine("Goal Completion: " + g.complete);
            Debug.WriteLine("Goal Creation Date: " + g.dateCreated);
            Debug.WriteLine("Goal Completion Date: " + g.dateCompleted);
            Debug.WriteLine("");
        }

        Debug.WriteLine("Post Foreach");
    }

    public async Task DropGoalsTable() {
        Debug.WriteLine("Dropping Goals Table");
        await DB.DropGoalTable();
        Debug.WriteLine("Goals Table Dropped!");

        await RefreshGoalList();
    }

    public async Task RefreshGoalList() {
        goalList.Clear();

        goalList = await DB.GetAll<Goal>();
    }

    public async Task SetupMissedDB() {
        List<Goal> tempGoalList = new List<Goal>();

        Goal testGoal1 = new Goal("Added Today Complete", DateTime.Now);
        Goal testGoal2 = new Goal("Added Today Missed", DateTime.Now);
        testGoal2.complete = false;
        Goal testGoal3 = new Goal("Added Yesterday Complete", DateTime.Now.AddDays(-1));
        Goal testGoal4 = new Goal("Added Yesterday Missed", DateTime.Now.AddDays(-1));
        testGoal4.complete = false;
        Goal testGoal5 = new Goal("Added 5 days ago Complete", DateTime.Now.AddDays(-5));
        Goal testGoal6 = new Goal("Added 5 days ago Missed", DateTime.Now.AddDays(-5));
        testGoal6.complete = false;
        Goal testGoal7 = new Goal("Added Tomorrow Complete", DateTime.Now.AddDays(1));
        Goal testGoal8 = new Goal("Added Tomorrow Missed", DateTime.Now.AddDays(1));
        testGoal8.complete = false;

        tempGoalList.Add(testGoal1);
        tempGoalList.Add(testGoal2);
        tempGoalList.Add(testGoal3);
        tempGoalList.Add(testGoal4);
        tempGoalList.Add(testGoal5);
        tempGoalList.Add(testGoal6);
        tempGoalList.Add(testGoal7);
        tempGoalList.Add(testGoal8);


        foreach(Goal goal in tempGoalList) {
            await DB.Insert<Goal>(goal);
        }

        Debug.WriteLine("Missed Goals dummy data added!!");
    }
}
